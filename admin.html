<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Senpai Anime</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        // Function to generate a unique ID
        function generateId() {
            return 'anime_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Function to load existing anime data
        function loadExistingAnime() {
            const animeList = document.getElementById('animeList');
            const animeData = JSON.parse(localStorage.getItem('animeData')) || [];
            const animeDropdown = document.getElementById('animeSelect');
            
            // Clear and update anime dropdown for episode addition
            if (animeDropdown) {
                animeDropdown.innerHTML = '<option value="">Select an anime</option>';
                animeData.forEach(anime => {
                    animeDropdown.innerHTML += `<option value="${anime.id}">${anime.title}</option>`;
                });
            }
            
            if (animeData.length === 0) {
                animeList.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-400">
                            <div class="flex flex-col items-center">
                                <i data-feather="inbox" class="w-12 h-12 mb-4 text-gray-600"></i>
                                <p class="text-lg">No anime uploaded yet</p>
                                <p class="text-sm text-gray-500 mb-4">Add your first anime using the form above</p>
                                <button onclick="document.getElementById('title').focus()" 
                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition duration-300 text-white">
                                    <i data-feather="plus" class="w-4 h-4 mr-2"></i> Add Your First Anime
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by date added (newest first)
            animeData.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            
            animeList.innerHTML = '';
            animeData.forEach(anime => {
                // Count episodes
                const episodeCount = anime.episodes ? anime.episodes.length : 1;
                
                animeList.innerHTML += `
                    <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition duration-200">
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-3">
                                <img src="${anime.thumbnail || 'https://placehold.co/100x150/1f2937/FFFFFF?text=Anime'}" 
                                     alt="${anime.title}" 
                                     class="w-12 h-16 object-cover rounded">
                                <div>
                                    <div class="font-medium text-white">${anime.title}</div>
                                    <div class="text-sm text-gray-400 flex items-center gap-1">
                                        <span>${anime.genre || 'No genre'}</span>
                                        <span class="mx-1">â€¢</span>
                                        <span>${anime.language || 'Subtitled'}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 bg-red-900/50 text-red-300 rounded-md text-xs">
                                ${episodeCount} ${episodeCount === 1 ? 'episode' : 'episodes'}
                            </span>
                        </td>
                        <td class="px-6 py-4 max-w-xs truncate">${anime.description || 'No description'}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <i data-feather="eye" class="w-4 h-4 text-gray-500"></i>
                                <span>${anime.views || 0}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">${new Date(anime.dateAdded).toLocaleDateString()}</td>
                        <td class="px-6 py-4">
                            ${anime.videoUrl ? `
                                <span class="px-2 py-1 bg-green-900/50 text-green-300 rounded-md text-xs">
                                    <i data-feather="check" class="w-3 h-3 mr-1 inline"></i> Available
                                </span>
                            ` : `
                                <span class="px-2 py-1 bg-gray-700 text-gray-400 rounded-md text-xs">
                                    <i data-feather="x" class="w-3 h-3 mr-1 inline"></i> None
                                </span>
                            `}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="editAnime('${anime.id}')" 
                                        class="flex items-center justify-center w-8 h-8 bg-blue-600/50 text-white rounded hover:bg-blue-700 transition duration-300"
                                        title="Edit">
                                    <i data-feather="edit" class="w-4 h-4"></i>
                                </button>
                                <button onclick="viewEpisodes('${anime.id}')" 
                                        class="flex items-center justify-center w-8 h-8 bg-purple-600/50 text-white rounded hover:bg-purple-700 transition duration-300"
                                        title="Episodes">
                                    <i data-feather="list" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteAnime('${anime.id}')" 
                                        class="flex items-center justify-center w-8 h-8 bg-red-600/50 text-white rounded hover:bg-red-700 transition duration-300"
                                        title="Delete">
                                    <i data-feather="trash" class="w-4 h-4"></i>
                                </button>
                                <a href="watch.html?id=${anime.id}&ep=1" 
                                   class="flex items-center justify-center w-8 h-8 bg-green-600/50 text-white rounded hover:bg-green-700 transition duration-300"
                                   title="Watch" target="_blank">
                                    <i data-feather="play" class="w-4 h-4"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            // Replace feather icons in new content
            feather.replace();
        }
        
        // Function to handle form submission for new anime
        function handleAnimeFormSubmit(event) {
            event.preventDefault();
            
            // Show loading state
            const submitBtn = document.getElementById('animeSubmitBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin mr-2"></i> Processing...`;
            feather.replace();
            
            // Get values from form
            const title = document.getElementById('title').value.trim();
            const genre = document.getElementById('genre').value;
            const totalEpisodes = document.getElementById('totalEpisodes').value || '1';
            const thumbnail = document.getElementById('thumbnail').value;
            const language = document.getElementById('language').value;
            const description = document.getElementById('description').value;
            
            // Check if we're editing or adding new
            const editingId = document.getElementById('editingId').value;
            
            // Get existing data
            let animeData = JSON.parse(localStorage.getItem('animeData')) || [];
            
            // Check for duplicate anime title when adding new
            if (!editingId) {
                const isDuplicate = animeData.some(anime => anime.title.toLowerCase() === title.toLowerCase());
                
                if (isDuplicate) {
                    alert(`An anime with the title "${title}" already exists. Please use a different title or add episodes to the existing anime.`);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    feather.replace();
                    return;
                }
            }
            
            if (editingId) {
                // Update existing anime
                const index = animeData.findIndex(anime => anime.id === editingId);
                if (index !== -1) {
                    animeData[index] = {
                        ...animeData[index],
                        title,
                        genre,
                        totalEpisodes,
                        thumbnail,
                        language,
                        description,
                        lastUpdated: new Date().toISOString()
                    };
                }
            } else {
                // Add new anime
                const newAnime = {
                    id: generateId(),
                    title,
                    genre,
                    totalEpisodes,
                    thumbnail,
                    language,
                    description,
                    views: 0,
                    dateAdded: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    episodes: [] // Start with empty episodes array
                };
                
                animeData.push(newAnime);
            }
            
            // Save to localStorage
            localStorage.setItem('animeData', JSON.stringify(animeData));
            
            // Reset form and update list
            document.getElementById('animeForm').reset();
            document.getElementById('editingId').value = '';
            document.getElementById('thumbnailPreview').style.backgroundImage = '';
            document.getElementById('thumbnailPreview').classList.add('hidden');
            
            // Show success notification
            showNotification(editingId ? 'Anime updated successfully!' : 'Anime added successfully! Now you can add episodes.');
            
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            feather.replace();
            
            // Update the table and dropdown
            loadExistingAnime();
            
            // Switch to episode tab if new anime was added
            if (!editingId) {
                switchTab('episodeTab');
            }
        }
        
        // Function to handle video file uploads with server-side storage and improved error handling
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            const isEpisodeForm = event.target.id === 'episodeVideoFile';
            
            if (!file) return;
            
            // Check file type - specifically check for MP4
            if (!file.type.startsWith('video/') && file.type !== 'video/mp4') {
                showNotification('Please select a video file (MP4 preferred)', 'error');
                event.target.value = '';
                return;
            }
            
            // Check file size (max 500MB)
            const maxSize = 500 * 1024 * 1024; // 500MB in bytes
            if (file.size > maxSize) {
                showNotification('File size exceeds 500MB limit. Please choose a smaller file.', 'error');
                event.target.value = '';
                return;
            }
            
            // Show file size info
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            showNotification(`Selected video: ${file.name} (${fileSizeMB}MB)`, 'success');
            
            // Extract episode number from filename
            const fileName = file.name;
            const episodeMatch = fileName.match(/[Ee]pisode\s*(\d+)|[Ee]p\s*(\d+)|[Ee]\s*(\d+)|S\d+E(\d+)/);
            
            if (episodeMatch && isEpisodeForm) {
                // Find the first capture group that's not undefined and is a number
                const extractedEp = episodeMatch.slice(1).find(match => match && !isNaN(match));
                if (extractedEp) {
                    document.getElementById('episodeNumber').value = extractedEp;
                    showNotification(`Episode ${extractedEp} detected from filename!`);
                }
            }
            
            // Show loading indicator
            const previewContainer = isEpisodeForm ? 'episodeVideoPreview' : 'videoPreview';
            document.getElementById(previewContainer).innerHTML = `
                <div class="flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
                    <span class="ml-3 text-gray-300">Uploading video (${fileSizeMB}MB)...</span>
                </div>
            `;
            
            // Create form data for upload
            const formData = new FormData();
            formData.append('file', file); // Changed from 'video' to 'file' to match server expectation
            
            // Upload the file to the server with improved error handling
            fetch('/api/upload/video', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || `Server error: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Display preview using the server URL
                    document.getElementById(previewContainer).innerHTML = `
                        <div class="relative rounded-lg overflow-hidden">
                            <video src="${data.fileUrl}" class="w-full h-auto" controls>
                                <source src="${data.fileUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                File: ${data.fileName} (${(data.fileSize / (1024 * 1024)).toFixed(2)}MB)
                            </div>
                        </div>
                    `;
                    
                    // Store the file URL in the form field
                    const urlField = isEpisodeForm ? 'episodeVideoUrl' : 'videoUrl';
                    document.getElementById(urlField).value = data.fileUrl;
                    
                    showNotification('Video uploaded successfully!', 'success');
                } else {
                    throw new Error(data.message || 'Upload failed');
                }
            })
            .catch(error => {
                console.error("Error uploading video:", error);
                showNotification(`Error uploading video: ${error.message}`, 'error');
                document.getElementById(previewContainer).innerHTML = '';
            });
        }

        // Function to handle episode form submission
        function handleEpisodeFormSubmit(event) {
            event.preventDefault();
            
            // Show loading state
            const submitBtn = document.getElementById('episodeSubmitBtn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-feather="loader" class="w-5 h-5 animate-spin mr-2"></i> Processing...`;
            feather.replace();
            
            // Get values from form
            const animeId = document.getElementById('animeSelect').value;
            const episodeNumber = document.getElementById('episodeNumber').value;
            const episodeTitle = document.getElementById('episodeTitle').value;
            const videoUrl = document.getElementById('episodeVideoUrl').value;
            
            if (!animeId) {
                alert('Please select an anime');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                feather.replace();
                return;
            }
            
            if (!episodeNumber) {
                alert('Please enter an episode number');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                feather.replace();
                return;
            }
            
            if (!videoUrl) {
                alert('Please enter a video URL or upload a video');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                feather.replace();
                return;
            }
            
            // Get existing data
            let animeData = JSON.parse(localStorage.getItem('animeData')) || [];
            const anime = animeData.find(a => a.id === animeId);
            
            if (!anime) {
                alert('Selected anime not found');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                feather.replace();
                return;
            }
            
            // Initialize episodes array if it doesn't exist
            if (!anime.episodes) {
                anime.episodes = [];
            }
            
            // Check if this episode number already exists
            const episodeExists = anime.episodes.some(ep => ep.episode == episodeNumber);
            if (episodeExists) {
                const confirmReplace = confirm(`Episode ${episodeNumber} already exists. Do you want to replace it?`);
                if (confirmReplace) {
                    // Remove existing episode
                    anime.episodes = anime.episodes.filter(ep => ep.episode != episodeNumber);
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    feather.replace();
                    return;
                }
            }
            
            // Add the new episode
            anime.episodes.push({
                episode: parseInt(episodeNumber),
                title: episodeTitle,
                videoUrl: videoUrl,
                dateAdded: new Date().toISOString()
            });
            
            // Update episode count information
            const epNumbers = anime.episodes.map(ep => parseInt(ep.episode));
            anime.currentEpisode = Math.max(...epNumbers);
            anime.lastUpdated = new Date().toISOString();
            
            try {
                // Save to localStorage
                localStorage.setItem('animeData', JSON.stringify(animeData));
                
                // Reset form
                document.getElementById('episodeForm').reset();
                document.getElementById('episodeVideoPreview').innerHTML = '';
                
                // Show success notification
                showNotification(`Episode ${episodeNumber} added to "${anime.title}" successfully!`);
                
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                feather.replace();
                
                // If episode list for this anime is currently visible, update it
                if (document.getElementById('episodeList').dataset.animeId === animeId) {
                    showEpisodeList(animeId);
                }
            } catch (error) {
                console.error("Error saving data:", error);
                showNotification('Error saving episode data: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                feather.replace();
            }
        }
        
        // Function to edit anime
        function editAnime(id) {
            const animeData = JSON.parse(localStorage.getItem('animeData')) || [];
            const anime = animeData.find(a => a.id === id);
            
            if (anime) {
                // Switch to anime tab
                switchTab('animeTab');
                
                // Fill form with anime data
                document.getElementById('title').value = anime.title;
                document.getElementById('genre').value = anime.genre || '';
                document.getElementById('totalEpisodes').value = anime.totalEpisodes || '';
                document.getElementById('thumbnail').value = anime.thumbnail || '';
                document.getElementById('language').value = anime.language || '';
                document.getElementById('description').value = anime.description || '';
                document.getElementById('editingId').value = anime.id;
                
                // Show thumbnail preview if exists
                if (anime.thumbnail) {
                    document.getElementById('thumbnailPreview').style.backgroundImage = `url(${anime.thumbnail})`;
                    document.getElementById('thumbnailPreview').classList.remove('hidden');
                }
                
                // Update form title and button
                document.getElementById('animeSubmitBtn').innerHTML = '<i data-feather="save" class="w-5 h-5 mr-2"></i> Update Anime';
                feather.replace();
                
                // Scroll to form
                document.getElementById('tabContent').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Function to view episodes for an anime
        function viewEpisodes(id) {
            // Show episode list section
            document.getElementById('episodeListSection').classList.remove('hidden');
            
            // Load and display episodes
            showEpisodeList(id);
            
            // Switch to episode tab
            switchTab('episodeTab');
            
            // Select the anime in the dropdown
            document.getElementById('animeSelect').value = id;
            
            // Scroll to episode list
            document.getElementById('episodeListSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Function to show episode list
        function showEpisodeList(animeId) {
            const episodeList = document.getElementById('episodeList');
            const animeData = JSON.parse(localStorage.getItem('animeData')) || [];
            const anime = animeData.find(a => a.id === animeId);
            
            // Store current anime ID in dataset
            episodeList.dataset.animeId = animeId;
            
            if (!anime) {
                episodeList.innerHTML = '<p class="text-red-500">Anime not found</p>';
                return;
            }
            
            // Update heading
            document.getElementById('episodeListTitle').textContent = `Episodes for "${anime.title}"`;
            
            // Check if anime has episodes
            if (!anime.episodes || anime.episodes.length === 0) {
                episodeList.innerHTML = `
                    <div class="p-8 text-center">
                        <p class="text-gray-400">No episodes found for this anime.</p>
                        <button onclick="document.getElementById('animeSelect').value='${animeId}'; document.getElementById('episodeNumber').focus()" 
                                class="mt-4 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition duration-300 text-white">
                            <i data-feather="plus" class="w-4 h-4 mr-2"></i> Add First Episode
                        </button>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            // Sort episodes by number
            const episodes = [...anime.episodes].sort((a, b) => parseInt(a.episode) - parseInt(b.episode));
            
            // Create episode list HTML
            let episodeHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            `;
            
            episodes.forEach(episode => {
                // Video source depends on URL type
                let videoSource = '';
                
                if (episode.videoUrl.startsWith('/uploads/')) {
                    // Server-side stored video
                    videoSource = `
                        <div class="relative aspect-video bg-black">
                            <video src="${episode.videoUrl}" class="w-full h-full object-contain" controls>
                                <source src="${episode.videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                } else if (episode.videoUrl.startsWith('{')) {
                    // Legacy file reference
                    videoSource = `
                        <div class="relative aspect-video bg-gray-800 flex items-center justify-center">
                            <div class="text-center p-4">
                                <i data-feather="alert-triangle" class="w-8 h-8 text-yellow-400 mb-2 mx-auto"></i>
                                <p class="text-gray-400">Legacy video reference</p>
                                <p class="text-sm text-gray-500">Please re-upload this episode</p>
                            </div>
                        </div>
                    `;
                } else {
                    // External video URL
                    videoSource = `
                        <div class="relative aspect-video bg-black">
                            <video src="${episode.videoUrl}" class="w-full h-full object-contain" controls>
                                <source src="${episode.videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                }
                
                episodeHTML += `
                    <div class="bg-gray-800/60 backdrop-blur-sm rounded-xl overflow-hidden border border-gray-700/50">
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold text-white">Episode ${episode.episode}</h3>
                                <div class="flex gap-1">
                                    <button onclick="editEpisode('${animeId}', ${episode.episode})" 
                                            class="flex items-center justify-center w-7 h-7 bg-blue-600/50 text-white rounded hover:bg-blue-700 transition duration-300"
                                            title="Edit">
                                        <i data-feather="edit" class="w-3 h-3"></i>
                                    </button>
                                    <button onclick="deleteEpisode('${animeId}', ${episode.episode})" 
                                            class="flex items-center justify-center w-7 h-7 bg-red-600/50 text-white rounded hover:bg-red-700 transition duration-300"
                                            title="Delete">
                                        <i data-feather="trash" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                            
                            ${episode.title ? `<p class="text-gray-300 mb-2">${episode.title}</p>` : ''}
                            
                            <div class="flex justify-between items-center text-sm text-gray-400">
                                <span>Added: ${new Date(episode.dateAdded).toLocaleDateString()}</span>
                                <a href="watch.html?id=${animeId}&ep=${episode.episode}" 
                                   class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-md transition duration-300 flex items-center gap-1"
                                   target="_blank">
                                    <i data-feather="play" class="w-3 h-3"></i> Watch
                                </a>
                            </div>
                        </div>
                        
                        ${videoSource}
                    </div>
                `;
            });
            
            episodeHTML += `</div>`;
            
            episodeList.innerHTML = episodeHTML;
            feather.replace();
        }
        
        // Function to edit episode
        function editEpisode(animeId, episodeNumber) {
            const animeData = JSON.parse(localStorage.getItem('animeData')) || [];
            const anime = animeData.find(a => a.id === animeId);
            
            if (!anime || !anime.episodes) return;
            
            const episode = anime.episodes.find(ep => ep.episode == episodeNumber);
            if (!episode) return;
            
            // Switch to episode tab
            switchTab('episodeTab');
            
            // Fill form with episode data
            document.getElementById('animeSelect').value = animeId;
            document.getElementById('episodeNumber').value = episode.episode;
            document.getElementById('episodeTitle').value = episode.title || '';
            document.getElementById('episodeVideoUrl').value = episode.videoUrl || '';
            
            // Show video preview if exists
            if (episode.videoUrl) {
                if (episode.videoUrl.startsWith('/uploads/')) {
                    // Server-side stored video
                    document.getElementById('episodeVideoPreview').innerHTML = `
                        <div class="relative rounded-lg overflow-hidden">
                            <video src="${episode.videoUrl}" class="w-full h-auto" controls>
                                <source src="${episode.videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                Current video
                            </div>
                        </div>
                    `;
                } else if (episode.videoUrl.startsWith('{')) {
                    // Legacy file reference
                    document.getElementById('episodeVideoPreview').innerHTML = `
                        <div class="relative rounded-lg overflow-hidden">
                            <div class="aspect-video bg-gray-800 flex items-center justify-center">
                                <div class="text-center p-4">
                                    <i data-feather="alert-triangle" class="w-12 h-12 text-yellow-400 mb-2 mx-auto"></i>
                                    <p class="text-gray-400">Legacy video reference</p>
                                    <p class="text-sm text-gray-500">Please re-upload this episode</p>
                                </div>
                            </div>
                            <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                Current video
                            </div>
                        </div>
                    `;
                } else {
                    // Regular video URL
                    document.getElementById('episodeVideoPreview').innerHTML = `
                        <div class="relative rounded-lg overflow-hidden">
                            <video src="${episode.videoUrl}" class="w-full h-auto" controls>
                                <source src="${episode.videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                Current video
                            </div>
                        </div>
                    `;
                }
            }
            
            // Update button and scroll to form
            document.getElementById('episodeSubmitBtn').innerHTML = '<i data-feather="save" class="w-5 h-5 mr-2"></i> Update Episode';
            feather.replace();
            document.getElementById('episodeForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Function to delete episode
        function deleteEpisode(animeId, episodeNumber) {
            if (confirm(`Are you sure you want to delete Episode ${episodeNumber}? This action cannot be undone.`)) {
                let animeData = JSON.parse(localStorage.getItem('animeData')) || [];
                const animeIndex = animeData.findIndex(a => a.id === animeId);
                
                if (animeIndex === -1 || !animeData[animeIndex].episodes) return;
                
                // Remove episode
                animeData[animeIndex].episodes = animeData[animeIndex].episodes.filter(ep => ep.episode != episodeNumber);
                
                // Update current episode if needed
                if (animeData[animeIndex].episodes.length > 0) {
                    const epNumbers = animeData[animeIndex].episodes.map(ep => parseInt(ep.episode));
                    animeData[animeIndex].currentEpisode = Math.max(...epNumbers);
                } else {
                    animeData[animeIndex].currentEpisode = 0;
                }
                
                animeData[animeIndex].lastUpdated = new Date().toISOString();
                
                // Save to localStorage
                localStorage.setItem('animeData', JSON.stringify(animeData));
                
                // Update episode list
                showEpisodeList(animeId);
                
                // Show notification
                showNotification(`Episode ${episodeNumber} deleted successfully!`);
            }
        }
        
        // Function to delete anime
        function deleteAnime(id) {
            if (confirm('Are you sure you want to delete this anime? This action cannot be undone.')) {
                let animeData = JSON.parse(localStorage.getItem('animeData')) || [];
                animeData = animeData.filter(anime => anime.id !== id);
                localStorage.setItem('animeData', JSON.stringify(animeData));
                
                // Update the table
                loadExistingAnime();
                
                // Show notification
                showNotification('Anime deleted successfully!');
            }
        }
        
        // Function to show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `fixed top-6 right-6 px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50 ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i>
                    <span>${message}</span>
                </div>
            `;
            feather.replace();
            notification.classList.remove('opacity-0');
            notification.classList.add('opacity-100');
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
            }, 3000);
        }
        
        // Helper function to handle thumbnail file uploads with better error handling
        function handleThumbnailUpload(event) {
            const file = event.target.files[0];
            
            if (!file) return;
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                event.target.value = '';
                return;
            }
            
            // Show loading indicator
            document.getElementById('imageFileName').textContent = `Uploading ${file.name}...`;
            document.getElementById('thumbnailPreview').style.backgroundImage = '';
            document.getElementById('thumbnailPreview').classList.add('hidden');
            
            // Create form data for upload
            const formData = new FormData();
            formData.append('file', file); // Changed from 'image' to 'file' to match server expectation
            
            // Upload to server with better error handling
            fetch('/api/upload/image', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || `Server error: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show thumbnail preview using the server URL
                    document.getElementById('thumbnailPreview').style.backgroundImage = `url(${data.fileUrl})`;
                    document.getElementById('thumbnailPreview').classList.remove('hidden');
                    document.getElementById('thumbnail').value = data.fileUrl;
                    
                    // Update file name display
                    document.getElementById('imageFileName').textContent = data.fileName;
                    
                    showNotification('Thumbnail uploaded successfully!', 'success');
                } else {
                    throw new Error(data.message || 'Upload failed');
                }
            })
            .catch(error => {
                console.error("Error uploading thumbnail:", error);
                showNotification(`Error uploading thumbnail: ${error.message}`, 'error');
                document.getElementById('imageFileName').textContent = 'Upload failed';
            });
        }
        
        // Function to switch tabs
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-red-600', 'text-white');
                button.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            // Show the selected tab
            document.getElementById(tabId + 'Content').classList.remove('hidden');
            
            // Add active class to the selected tab button
            document.getElementById(tabId + 'Button').classList.remove('bg-gray-700', 'text-gray-300');
            document.getElementById(tabId + 'Button').classList.add('bg-red-600', 'text-white');
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Replace all feather icons
            feather.replace();
            
            // Load existing anime data
            loadExistingAnime();
            
            // Set up form submission handlers
            document.getElementById('animeForm').addEventListener('submit', handleAnimeFormSubmit);
            document.getElementById('episodeForm').addEventListener('submit', handleEpisodeFormSubmit);
            
            // Set up file upload handlers
            document.getElementById('thumbnailFile').addEventListener('change', handleThumbnailUpload);
            document.getElementById('episodeVideoFile').addEventListener('change', handleVideoUpload);
            
            // Set up anime select change handler
            document.getElementById('animeSelect').addEventListener('change', function() {
                const animeId = this.value;
                if (animeId) {
                    showEpisodeList(animeId);
                    document.getElementById('episodeListSection').classList.remove('hidden');
                }
            });
        });
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(239, 68, 68, 0.6);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(239, 68, 68, 0.8);
        }
        
        /* Red gradient for heading */
        .red-gradient {
            background: linear-gradient(90deg, #ff4b4b 0%, #ff0000 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        
        /* Glassmorphism effect */
        .glassmorphism {
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 77, 77, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Notification -->
    <div id="notification" class="opacity-0 transition-opacity duration-300 z-50"></div>
    
    <!-- Header -->
    <header class="bg-gray-800/80 backdrop-blur-md shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-red-600 to-red-500 flex items-center justify-center text-xl font-bold">S</div>
                    <div class="ml-3">
                        <h1 class="text-xl font-bold red-gradient">Senpai Anime</h1>
                        <p class="text-xs text-red-400">Admin Panel</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="px-4 py-2 bg-gray-700/80 hover:bg-gray-600 rounded-lg transition duration-300 text-sm flex items-center gap-2">
                        <i data-feather="home"></i>
                        <span class="hidden sm:inline">Back to Website</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Tab Navigation -->
        <div class="flex mb-6 border-b border-gray-700">
            <button id="animeTabButton" class="tab-button px-6 py-3 font-medium bg-red-600 text-white rounded-t-lg" onclick="switchTab('animeTab')">
                <i data-feather="film" class="w-5 h-5 mr-2 inline"></i> Add Anime
            </button>
            <button id="episodeTabButton" class="tab-button px-6 py-3 font-medium bg-gray-700 text-gray-300 rounded-t-lg ml-2" onclick="switchTab('episodeTab')">
                <i data-feather="layers" class="w-5 h-5 mr-2 inline"></i> Add Episodes
            </button>
        </div>
        
        <!-- Tab Content -->
        <div id="tabContent" class="mb-8">
            <!-- Anime Tab -->
            <div id="animeTabContent" class="tab-content bg-gray-800/60 backdrop-blur-sm rounded-xl p-6 shadow-lg">
                <h2 class="text-2xl font-bold text-red-400 mb-6 flex items-center gap-2">
                    <i data-feather="film"></i> Add New Anime Series
                </h2>
                
                <form id="animeForm" class="space-y-6">
                    <input type="hidden" id="editingId" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="title" class="block text-sm font-medium mb-2">Anime Title</label>
                            <input type="text" id="title" required
                                   class="w-full px-4 py-2 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600">
                        </div>
                        
                        <div>
                            <label for="genre" class="block text-sm font-medium mb-2">Genre</label>
                            <select id="genre" required
                                    class="w-full px-4 py-2 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600">
                                <option value="">Select Genre</option>
                                <option value="Action">Action</option>
                                <option value="Adventure">Adventure</option>
                                <option value="Comedy">Comedy</option>
                                <option value="Drama">Drama</option>
                                <option value="Fantasy">Fantasy</option>
                                <option value="Horror">Horror</option>
                                <option value="Isekai">Isekai</option>
                                <option value="Mystery">Mystery</option>
                                <option value="Romance">Romance</option>
                                <option value="Sci-Fi">Sci-Fi</option>
                                <option value="Slice of Life">Slice of Life</option>
                                <option value="Sports">Sports</option>
                                <option value="Supernatural">Supernatural</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="totalEpisodes" class="block text-sm font-medium mb-2">Total Episodes</label>
                            <input type="number" id="totalEpisodes" min="1"
                                  class="w-full px-4 py-2 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600"
                                  placeholder="Number of episodes">
                        </div>
                        
                        <div>
                            <label for="language" class="block text-sm font-medium mb-2">Language</label>
                            <select id="language" required
                                    class="w-full px-4 py-2 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600">
                                <option value="">Select Language</option>
                                <option value="Subtitled">Subtitled</option>
                                <option value="Dubbed">Dubbed</option>
                                <option value="Raw">Raw (No Subtitles)</option>
                            </select>
                        </div>
                         
                        <div>
                            <label for="thumbnail" class="block text-sm font-medium mb-2">Thumbnail URL</label>
                            <div class="relative">
                                <input type="text" id="thumbnail" placeholder="https://example.com/image.jpg"
                                      class="w-full px-4 py-2 pl-10 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600">
                                <i data-feather="link" class="absolute left-3 top-3 text-gray-400 w-4 h-4"></i>
                            </div>
                            <div class="mt-2 text-sm text-gray-400 flex items-center gap-2">
                                <i data-feather="info" class="w-4 h-4"></i>
                                <span id="imageFileName">No file selected</span>
                            </div>
                            <div id="thumbnailPreview" class="mt-3 h-40 w-28 bg-cover bg-center rounded-lg hidden"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Upload Thumbnail</label>
                            <label class="flex items-center px-4 py-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition duration-300">
                                <i data-feather="image" class="w-5 h-5 mr-2"></i>
                                <span>Choose Image</span>
                                <input type="file" id="thumbnailFile" accept="image/*" class="hidden">
                            </label>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium mb-2">Description</label>
                            <textarea id="description" rows="4"
                                     class="w-full px-4 py-2 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" id="animeSubmitBtn"
                                class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition duration-300 flex items-center gap-2">
                            <i data-feather="plus-circle" class="w-5 h-5"></i> Add Anime
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Episode Tab -->
            <div id="episodeTabContent" class="tab-content bg-gray-800/60 backdrop-blur-sm rounded-xl p-6 shadow-lg hidden">
                <h2 class="text-2xl font-bold text-red-400 mb-6 flex items-center gap-2">
                    <i data-feather="layers"></i> Add New Episode
                </h2>
                
                <form id="episodeForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="animeSelect" class="block text-sm font-medium mb-2">Select Anime</label>
                            <select id="animeSelect" required
                                    class="w-full px-4 py-2 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600">
                                <option value="">Select an anime</option>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        
                        <div>
                            <label for="episodeNumber" class="block text-sm font-medium mb-2">Episode Number</label>
                            <input type="number" id="episodeNumber" min="1" required
                                   class="w-full px-4 py-2 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600"
                                   placeholder="Auto-detected from filename">
                        </div>
                        
                        <div>
                            <label for="episodeTitle" class="block text-sm font-medium mb-2">Episode Title (Optional)</label>
                            <input type="text" id="episodeTitle"
                                   class="w-full px-4 py-2 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600"
                                   placeholder="Episode title">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="episodeVideoUrl" class="block text-sm font-medium mb-2">Video URL</label>
                            <div class="relative">
                                <input type="text" id="episodeVideoUrl" placeholder="https://example.com/video.mp4" required
                                      class="w-full px-4 py-2 pl-10 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600">
                                <i data-feather="link" class="absolute left-3 top-3 text-gray-400 w-4 h-4"></i>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">
                                Enter a URL or upload a video file below
                            </p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Upload Video</label>
                            <label class="flex items-center px-4 py-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition duration-300">
                                <i data-feather="video" class="w-5 h-5 mr-2"></i>
                                <span>Choose Video (MP4, max 500MB)</span>
                                <input type="file" id="episodeVideoFile" accept="video/mp4,video/*" class="hidden">
                            </label>
                            <p class="mt-2 text-xs text-gray-500">
                                Episode number will be automatically detected from filename if possible (e.g., "Episode 3", "Ep03", "S01E05")
                            </p>
                        </div>
                    </div>
                    
                    <div id="episodeVideoPreview" class="mt-3"></div>
                    
                    <div class="flex justify-end">
                        <button type="submit" id="episodeSubmitBtn"
                                class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition duration-300 flex items-center gap-2">
                            <i data-feather="plus-circle" class="w-5 h-5"></i> Add Episode
                        </button>
                    </div>
                </form>
                
                <!-- Episode List Section -->
                <div id="episodeListSection" class="mt-8 pt-8 border-t border-gray-700 hidden">
                    <h3 id="episodeListTitle" class="text-xl font-bold text-red-400 mb-4">Episodes</h3>
                    <div id="episodeList" class="mt-4">
                        <!-- Episode list will be populated via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Anime List -->
        <div class="bg-gray-800/60 backdrop-blur-sm rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-red-400 flex items-center gap-2">
                    <i data-feather="film"></i> Anime Collection
                </h2>
                
                <div class="relative">
                    <input type="text" id="tableSearch" placeholder="Search anime..." 
                           class="px-4 py-2 pl-10 bg-gray-700/70 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-600 text-sm">
                    <i data-feather="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-700/70">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Anime</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Episodes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Views</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date Added</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Video</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="animeList">
                        <!-- Anime list will be populated via JavaScript -->
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-400">
                                <div class="flex justify-center mb-4">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
                                </div>
                                <p>Loading anime collection...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800/80 backdrop-blur-sm py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>&copy; 2025 Senpai Anime Admin. All rights reserved.</p>
            <p class="mt-1">A personal anime collection website.</p>
        </div>
    </footer>
</body>
</html>
